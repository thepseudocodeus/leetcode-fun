#!/usr/bin/env bash
set -e

echo "üîß Starting devcontainer setup..."

# Check for required tools, which should now be in the base environment
if ! command -v micromamba &>/dev/null; then
    echo "‚ùå Micromamba not installed!"
    exit 1
fi

if ! command -v poetry &>/dev/null; then
    echo "‚ùå Poetry not installed!"
    exit 1
fi

# Dynamically get project name
PROJECT_NAME=$(basename "$(pwd)")
ENV_NAME="$PROJECT_NAME"

# Activate shell hook
eval "$(micromamba shell hook -s bash)"

# Create and activate environment
if ! micromamba env list | grep -q "$ENV_NAME"; then
    echo "üêç Creating Python 3.13 environment '$ENV_NAME'..."
    micromamba create -y -n "$ENV_NAME" python=3.13
    micromamba activate "$ENV_NAME"
    echo "üì¶ Installing Python dependencies via Poetry..."
    poetry install --no-dev
else
    echo "‚úÖ Environment '$ENV_NAME' already exists"
    micromamba activate "$ENV_NAME"
    echo "üîÑ Updating Python dependencies via Poetry..."
    poetry update
fi

# Install pre-commit hooks for the current project
if [ -f ".pre-commit-config.yaml" ]; then
    echo " hooks..."
    pre-commit install --install-hooks
else
    echo "‚ö†Ô∏è No .pre-commit-config.yaml found, skipping pre-commit setup."
fi

echo "‚úÖ Devcontainer setup complete!"
